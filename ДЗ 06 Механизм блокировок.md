# üß™ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞–±–æ—Ç–∞: –ú–µ—Ö–∞–Ω–∏–∑–º –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –≤ PostgreSQL

## üéØ –¶–µ–ª—å

–ü–æ–Ω—è—Ç—å, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ –∏ —Å—Ç—Ä–æ–∫ –≤ PostgreSQL –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ.

---

## üîß –ü–æ–¥–≥–æ—Ç–æ–≤–∏–ª –æ–∫—Ä—É–∂–µ–Ω–∏–µ

–í—ã–ø–æ–ª–Ω–∏–ª:

```sql
-- –°–æ–∑–¥–∞–¥–∞–ª —Ç–µ—Å—Ç–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É
CREATE TABLE test_table (
    id SERIAL,
    value TEXT
);

-- –î–æ–±–∞–≤–∏–ª —Å—Ç—Ä–æ–∫–∏
INSERT INTO test_table (value) VALUES 
('initial 1'), ('initial 2'), ('initial 3');
```

![image](https://github.com/user-attachments/assets/c6d350fd-ef96-4a4e-84fa-689c2be8d606)

---

## ‚öôÔ∏è –ß–∞—Å—Ç—å 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ–ª–≥–∏—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

### üìå –ù–∞—Å—Ç—Ä–æ–∏–ª –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ `postgresql.conf`:

```
log_lock_waits = on
deadlock_timeout = 200ms
```

–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏–ª —Å–µ—Ä–≤–µ—Ä PostgreSQL:

```bash
sudo systemctl restart postgresql
```
![image](https://github.com/user-attachments/assets/6641d5af-dee4-4b92-9bb3-9c12936393b5)


### üîé –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏

–û—Ç–∫—Ä—ã–ª **–¥–≤–µ —Å–µ—Å—Å–∏–∏**:

#### –°–µ–∞–Ω—Å 1

```sql
BEGIN;
UPDATE test_table SET value = 'A' WHERE id = 1;
-- –û—Å—Ç–∞–≤–ª—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –æ—Ç–∫—Ä—ã—Ç–æ–π
```

#### –°–µ–∞–Ω—Å 2

```sql
BEGIN;
UPDATE test_table SET value = 'B' WHERE id = 1;
-- –ñ–¥—ë—Ç > 200 –º—Å ‚Äî –≤ –∂—É—Ä–Ω–∞–ª–µ –ø–æ—è–≤–∏—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ
```

#### –ü—Ä–æ—Å–º–æ—Ç—Ä –∂—É—Ä–Ω–∞–ª–∞

```bash
tail -f /var/log/postgresql/postgresql-14-main.log
```
![image](https://github.com/user-attachments/assets/27780fa0-eb8a-4c07-bba0-2248d0382f33)

---

## üîÅ –ß–∞—Å—Ç—å 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ —Ç—Ä–µ–º—è —Å–µ—Å—Å–∏—è–º–∏

–û—Ç–∫—Ä—ã–ª **—Ç—Ä–∏ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞/—Å–µ–∞–Ω—Å–∞**.

#### –°–µ–∞–Ω—Å 1

```sql
BEGIN;
UPDATE test_table SET value = 'first' WHERE id = 1;
```

#### –°–µ–∞–Ω—Å 2

```sql
BEGIN;
UPDATE test_table SET value = 'second' WHERE id = 1;
```

#### –°–µ–∞–Ω—Å 3

```sql
BEGIN;
UPDATE test_table SET value = 'third' WHERE id = 1;
```

#### –û—Ç–¥–µ–ª—å–Ω–∞—è —Å–µ—Å—Å–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

```sql
SELECT pid, mode, granted, relation::regclass, virtualtransaction, locktype
FROM pg_locks
WHERE relation IS NOT NULL ORDER BY 1;
```
![image](https://github.com/user-attachments/assets/77a22cee-c09e-4d51-a9ce-41d0c938b717)

#### –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

##### RowExclusiveLock (relation)

–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π UPDATE/DELETE

–í—Å–µ —Ç—Ä–∏ —Å–µ—Å—Å–∏–∏ –ø–æ–ª—É—á–∏–ª–∏ —ç—Ç—É –±–ª–æ–∫–∏—Ä–æ–≤–∫—É (granted = t)

##### ExclusiveLock (tuple)

–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ (–∫–æ—Ä—Ç–µ–∂–∞)

–¢–æ–ª—å–∫–æ –≤—Ç–æ—Ä–∞—è —Å–µ—Å—Å–∏—è –ø–æ–ª—É—á–∏–ª–∞ —ç—Ç—É –±–ª–æ–∫–∏—Ä–æ–≤–∫—É (granted = t)

–¢—Ä–µ—Ç—å—è —Å–µ—Å—Å–∏—è –æ–∂–∏–¥–∞–µ—Ç (granted = f)

#### –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

–ö–∞–∂–¥–∞—è —Å–µ—Å—Å–∏—è –∏–º–µ–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä virtualtransaction

–ü–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

---

## üí• –ß–∞—Å—Ç—å 3: –í–∑–∞–∏–º–æ–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ç—Ä—ë—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

### üìã –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞

```sql
DROP TABLE IF EXISTS t;

CREATE TABLE t (
    id INT PRIMARY KEY,
    val TEXT
);

INSERT INTO t VALUES (1, 'a'), (2, 'b'), (3, 'c');
```

### üß© –°—Ü–µ–Ω–∞—Ä–∏–π –≤ —Ç—Ä—ë—Ö —Å–µ–∞–Ω—Å–∞—Ö

#### –°–µ–∞–Ω—Å 1

```sql
BEGIN;
UPDATE t SET val = 'x' WHERE id = 1;
-- –ü–û–¢–û–ú: UPDATE t SET val = 'x2' WHERE id = 2;
```

#### –°–µ–∞–Ω—Å 2

```sql
BEGIN;
UPDATE t SET val = 'y' WHERE id = 2;
-- –ü–û–¢–û–ú: UPDATE t SET val = 'y2' WHERE id = 3;
```

#### –°–µ–∞–Ω—Å 3

```sql
BEGIN;
UPDATE t SET val = 'z' WHERE id = 3;
-- –ü–û–¢–û–ú: UPDATE t SET val = 'z2' WHERE id = 1;
```

üîÅ –ó–∞–≤–µ—Ä—à–∏ ¬´–≤—Ç–æ—Ä—ã–µ¬ª –∫–æ–º–∞–Ω–¥—ã –ø–æ –∫—Ä—É–≥—É ‚Äî –±—É–¥–µ—Ç deadlock:

```
ERROR:  deadlock detected
DETAIL:  Process 12345 waits for ShareLock on transaction 67890; blocked by process ...
```

---

## ‚ùì –ß–∞—Å—Ç—å 4: UPDATE –±–µ–∑ WHERE ‚Äî –º–æ–≥—É—Ç –ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥ –¥—Ä—É–≥–∞?

–ù–µ—Ç, –Ω–æ –º–æ–∂–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:

#### –°–µ–∞–Ω—Å 1

```sql
BEGIN;
UPDATE test_table SET value = 'from session 1';
-- –ù–µ –∫–æ–º–º–∏—Ç–∏–º
```

#### –°–µ–∞–Ω—Å 2

```sql
BEGIN;
UPDATE test_table SET value = 'from session 2';
-- –û–∂–∏–¥–∞–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–µ—Ä–≤–æ–π, –Ω–æ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç –≤–∑–∞–∏–º–æ–±–ª–æ–∫–∏—Ä–æ–≤–∫—É
```

---

## ‚úÖ –í—ã–≤–æ–¥—ã

- PostgreSQL –ª–æ–≥–∏—Ä—É–µ—Ç –¥–æ–ª–≥–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–µ.
- –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ `pg_locks` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏ –∏—Ö –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤.
- –í–∑–∞–∏–º–æ–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ª–µ–≥–∫–æ –º–æ–¥–µ–ª–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–Ω–æ–º –¥–æ—Å—Ç—É–ø–µ –∫ —Å—Ç—Ä–æ–∫–∞–º.
- –ö–æ–º–∞–Ω–¥—ã `UPDATE` –±–µ–∑ `WHERE` –≤—ã–∑—ã–≤–∞—é—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –≤—Å–µ–π —Ç–∞–±–ª–∏—Ü—ã, –Ω–æ –Ω–µ –≤–∑–∞–∏–º–Ω—É—é.

---

> üí° –ù–µ –∑–∞–±—ã–≤–∞–π –∑–∞–≤–µ—Ä—à–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ `COMMIT` –∏–ª–∏ `ROLLBACK`, —á—Ç–æ–±—ã –Ω–µ –æ—Å—Ç–∞–≤–ª—è—Ç—å –≤–∏—Å—è—â–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏.
