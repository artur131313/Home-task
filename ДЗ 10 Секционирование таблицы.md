# üß† –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ  
## üìÅ –°–µ–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –≤ PostgreSQL

### üéØ –¶–µ–ª—å:
- –ù–∞—É—á–∏—Ç—å—Å—è –≤—ã–ø–æ–ª–Ω—è—Ç—å —Å–µ–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –≤ PostgreSQL  
- –ü–æ–≤—ã—Å–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ —É–ø—Ä–æ—Å—Ç–∏—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏

---

## üìå –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è

–ù–∞ –æ—Å–Ω–æ–≤–µ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö [PostgreSQL DemoDB](https://postgrespro.ru/education/demodb) –∑–∞ 3 –º–µ—Å—è—Ü–∞ –ø—Ä–∏–º–µ–Ω—ë–Ω –º–µ—Ç–æ–¥ —Å–µ–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã `bookings` —Å —Ü–µ–ª—å—é –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ —É–¥–æ–±—Å—Ç–≤–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ–ª—å—à–∏–º–∏ –æ–±—ä—ë–º–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö.

---

## üß© –®–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### 1. –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö

–û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä–µ—Å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–∞–±–ª–∏—Ü–∞ `bookings`, —Å–æ–¥–µ—Ä–∂–∞—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è—Ö. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã:

```sql
CREATE TABLE bookings.bookings (
	book_ref bpchar(6) NOT NULL,
	book_date timestamptz NOT NULL,
	total_amount numeric(10, 2) NOT NULL,
	CONSTRAINT bookings_pkey PRIMARY KEY (book_ref)
);
```

–ö–ª—é—á–µ–≤—ã–º —Å—Ç–æ–ª–±—Ü–æ–º –¥–ª—è —Å–µ–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–±—Ä–∞–Ω `book_date`, —Ç–∞–∫ –∫–∞–∫:
- –¥–∞–Ω–Ω—ã–µ –ª–æ–≥–∏—á–µ—Å–∫–∏ –≥—Ä—É–ø–ø–∏—Ä—É—é—Ç—Å—è –ø–æ –¥–∞—Ç–µ;
- –º–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω—è—Ç—å —Å–µ–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω—É (range);
- —É–¥–æ–±–Ω–æ –≤—ã–¥–µ–ª—è—Ç—å —Å–µ–∫—Ü–∏–∏ –ø–æ –º–µ—Å—è—Ü–∞–º –∏–ª–∏ –≥–æ–¥–∞–º –¥–ª—è –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –æ—á–∏—Å—Ç–∫–∏.

---

### 2. –í—ã–±–æ—Ä —Ç–∞–±–ª–∏—Ü—ã –∏ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ

**–í—ã–±—Ä–∞–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞:** `bookings`

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**  
–¢–∞–±–ª–∏—Ü–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –±–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –ª–æ–≥–∏—á–µ—Å–∫–∏ —Ä–∞–∑–±–∏–≤–∞—é—Ç—Å—è –ø–æ –¥–∞—Ç–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è. –ß–∞—â–µ –≤—Å–µ–≥–æ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ –¥–∞—Ç–µ ‚Äî –∑–∞ –¥–µ–Ω—å, –Ω–µ–¥–µ–ª—é, –º–µ—Å—è—Ü. –≠—Ç–æ –¥–µ–ª–∞–µ—Ç –µ—ë –∏–¥–µ–∞–ª—å–Ω–æ–π –¥–ª—è —Å–µ–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω—É –¥–∞—Ç.

---

### 3. –¢–∏–ø —Å–µ–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

**–í—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∏–ø:** –°–µ–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ **–¥–∏–∞–ø–∞–∑–æ–Ω—É** (`RANGE`)  
**–ö–ª—é—á:** `book_date`  
**–ü—Ä–∏—á–∏–Ω–∞:** –£–¥–æ–±–Ω–æ —Ä–∞–∑–±–∏—Ç—å –ø–æ –≥–æ–¥–∞–º –∏–ª–∏ –º–µ—Å—è—Ü–∞–º, –ª–µ–≥–∫–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å.

---

### 4. –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã

```sql
CREATE TABLE bookings_partitioned (
    book_ref        char(6)     NOT NULL,
    book_date       timestamp   NOT NULL,
    total_amount    numeric     NOT NULL
) PARTITION BY RANGE (book_date);
```

–°–æ–∑–¥–∞—ë–º –ø–∞—Ä—Ç–∏—Ü–∏–∏ –ø–æ –≥–æ–¥–∞–º:

```sql
CREATE TABLE bookings_2016 PARTITION OF bookings_partitioned
    FOR VALUES FROM ('2016-01-01') TO ('2017-01-01');

CREATE TABLE bookings_2017 PARTITION OF bookings_partitioned
    FOR VALUES FROM ('2017-01-01') TO ('2018-01-01');

CREATE TABLE bookings_2018 PARTITION OF bookings_partitioned
    FOR VALUES FROM ('2018-01-01') TO ('2019-01-01');

CREATE TABLE bookings_2019 PARTITION OF bookings_partitioned
    FOR VALUES FROM ('2019-01-01') TO ('2020-01-01');
```

---

### 5. –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

```sql
INSERT INTO bookings_partitioned
SELECT * FROM bookings;
```

–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:

```sql
SELECT tableoid::regclass AS partition, count(*)
FROM bookings_partitioned
GROUP BY tableoid;
```

---

### 6. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

#### –î–æ —Å–µ–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:

```sql
EXPLAIN ANALYZE
SELECT * FROM bookings
WHERE book_date BETWEEN '2017-06-01' AND '2017-06-30';
```

#### –ü–æ—Å–ª–µ —Å–µ–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:

```sql
EXPLAIN ANALYZE
SELECT * FROM bookings_partitioned
WHERE book_date BETWEEN '2017-06-01' AND '2017-06-30';
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**  
–ó–∞–ø—Ä–æ—Å—ã –ø–æ—Å–ª–µ —Å–µ–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —á–∏—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –ø–∞—Ä—Ç–∏—Ü–∏—é (`bookings_2017`), —á—Ç–æ —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ —Å–Ω–∏–∂–∞–µ—Ç –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.

---

### 7. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π

#### –í—Å—Ç–∞–≤–∫–∞:

```sql
INSERT INTO bookings_partitioned VALUES ('ZZ9999', '2017-07-15', 500.00);
```

#### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ:

```sql
UPDATE bookings_partitioned
SET total_amount = 550.00
WHERE book_ref = 'ZZ9999';
```

#### –£–¥–∞–ª–µ–Ω–∏–µ:

```sql
DELETE FROM bookings_partitioned
WHERE book_ref = 'ZZ9999';
```

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

---

### 8. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –≤—ã–≤–æ–¥

```sql
COMMENT ON TABLE bookings_partitioned IS
'–°–µ–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ bookings –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω—É –¥–∞—Ç book_date.';

COMMENT ON TABLE bookings_2017 IS
'–ü–∞—Ä—Ç–∏—Ü–∏—è –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π —Å 01.01.2017 –ø–æ 31.12.2017';
```

---

## üìà –í—ã–≤–æ–¥

–°–µ–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã `bookings` –ø–æ –¥–∞—Ç–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:
- –£–º–µ–Ω—å—à–∏–ª–æ –æ–±—ä—ë–º –¥–∞–Ω–Ω—ã—Ö, —Å–∫–∞–Ω–∏—Ä—É–µ–º—ã—Ö –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤;
- –ü–æ–≤—ã—Å–∏–ª–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã–±–æ—Ä–æ–∫ –ø–æ –¥–∞—Ç–µ;
- –£–ø—Ä–æ—Å—Ç–∏–ª–æ –≤–æ–∑–º–æ–∂–Ω—É—é –∞—Ä—Ö–∏–≤–∞—Ü–∏—é –∏ —É–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö;
- –°–¥–µ–ª–∞–ª–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏ –±–æ–ª–µ–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º.

---

## üìé –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### SQL-—Å–∫—Ä–∏–ø—Ç —Å–µ–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

```sql
-- –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
CREATE TABLE bookings_partitioned (
    book_ref        char(6)     NOT NULL,
    book_date       timestamp   NOT NULL,
    total_amount    numeric     NOT NULL
) PARTITION BY RANGE (book_date);

-- –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π
CREATE TABLE bookings_2016 PARTITION OF bookings_partitioned
    FOR VALUES FROM ('2016-01-01') TO ('2017-01-01');

CREATE TABLE bookings_2017 PARTITION OF bookings_partitioned
    FOR VALUES FROM ('2017-01-01') TO ('2018-01-01');

CREATE TABLE bookings_2018 PARTITION OF bookings_partitioned
    FOR VALUES FROM ('2018-01-01') TO ('2019-01-01');

CREATE TABLE bookings_2019 PARTITION OF bookings_partitioned
    FOR VALUES FROM ('2019-01-01') TO ('2020-01-01');

-- –ü–µ—Ä–µ–Ω–æ—Å –¥–∞–Ω–Ω—ã—Ö
INSERT INTO bookings_partitioned
SELECT * FROM bookings;
```
