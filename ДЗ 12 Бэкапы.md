# Домашнее задание: Бэкапы PostgreSQL

## Цель
- Применить логический бэкап.
- Восстановиться из бэкапа.

## Шаги выполнения

### 1. Создание ВМ/докера с PostgreSQL
Использован Docker с официальным образом PostgreSQL:
```bash
docker run --name pg-backup-task -e POSTGRES_PASSWORD=password -d postgres
```

### 2. Создание БД, схемы и таблицы
Подключение к БД:
```bash
docker exec -it pg-backup-task psql -U postgres
```

SQL-запросы:
```sql
CREATE DATABASE backup_test;
\c backup_test

CREATE SCHEMA backup_schema;

CREATE TABLE backup_schema.table1 (
    id SERIAL PRIMARY KEY,
    data TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 3. Заполнение таблицы автосгенерированными данными
```sql
INSERT INTO backup_schema.table1 (data)
SELECT md5(random()::text) FROM generate_series(1, 100);
```

### 4. Создание каталога для бэкапов
```bash
docker exec -it pg-backup-task mkdir -p /var/lib/postgresql/backups
```

### 5. Логический бэкап с использованием COPY
```bash
docker exec -it pg-backup-task bash -c 'psql -U postgres -d backup_test -c "\copy backup_schema.table1 TO '/var/lib/postgresql/backups/table1_backup.csv' WITH CSV HEADER"'
```

### 6. Восстановление во вторую таблицу
Создаем вторую таблицу:
```sql
CREATE TABLE backup_schema.table2 (LIKE backup_schema.table1 INCLUDING ALL);
```

Восстанавливаем данные:
```bash
docker exec -it pg-backup-task bash -c 'psql -U postgres -d backup_test -c "\copy backup_schema.table2 FROM '/var/lib/postgresql/backups/table1_backup.csv' WITH CSV HEADER"'
```

### 7. Бэкап двух таблиц с помощью pg_dump
```bash
docker exec -it pg-backup-task pg_dump -U postgres -d backup_test -n backup_schema -F c -f /var/lib/postgresql/backups/dump.custom
```

### 8. Восстановление только второй таблицы в новую БД
Создаем новую БД:
```sql
CREATE DATABASE restored_db;
```

Восстанавливаем только table2:
```bash
docker exec -it pg-backup-task pg_restore -U postgres -d restored_db -t backup_schema.table2 /var/lib/postgresql/backups/dump.custom
```

## Проверка
```sql
\c restored_db
SELECT COUNT(*) FROM backup_schema.table2;
```
Результат: 100 записей.

## Возникшие проблемы и решения
1. **Проблема**: Ошибки прав доступа при создании файлов бэкапа.
   - **Решение**: Использовал каталог `/var/lib/postgresql/backups`, который принадлежит пользователю postgres.

2. **Проблема**: При восстановлении из CSV возникали ошибки формата.
   - **Решение**: Указал явно `WITH CSV HEADER` в командах COPY.

3. **Проблема**: pg_restore пытался восстановить все таблицы.
   - **Решение**: Использовал флаг `-t` для указания конкретной таблицы.

## Вывод
Успешно выполнено:
- Создание логических бэкапов через COPY и pg_dump.
- Выборочное восстановление таблиц.
- Освоены основные утилиты работы с бэкапами в PostgreSQL.
```
